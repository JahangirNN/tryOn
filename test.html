<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Virtual Try-On (Robust URL Loading)</title>
  <style>
    :root {
      --primary-color: #007bff; --light-gray: #f0f2f5; --medium-gray: #ccc;
      --dark-gray: #555; --bg-color: #fff; --card-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0; background-color: var(--light-gray); color: var(--dark-gray);
      display: flex; justify-content: center; padding: 20px;
    }
    .main-container { display: flex; flex-wrap: wrap; gap: 20px; width: 100%; max-width: 1400px; }
    .panel { background: var(--bg-color); border-radius: 8px; box-shadow: var(--card-shadow); padding: 25px; flex: 1; }
    .controls-panel { min-width: 350px; flex-basis: 400px; }
    .results-panel { min-width: 400px; flex-basis: 500px; }
    h1, h2 { color: #333; }
    h1 { text-align: center; margin-bottom: 25px; }
    h2 { border-bottom: 1px solid var(--light-gray); padding-bottom: 10px; margin-top: 20px; }
    .input-group { margin-bottom: 15px; }
    label { font-weight: 600; display: block; margin-bottom: 5px; }
    input[type="text"], textarea, select { width: 100%; padding: 10px; border: 1px solid var(--medium-gray); border-radius: 4px; box-sizing: border-box; }
    textarea { resize: vertical; min-height: 80px; }
    button#submitBtn {
      width: 100%; padding: 12px; background-color: var(--primary-color); color: white;
      border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer;
      transition: background-color 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    button#submitBtn:hover { background-color: #0056b3; }
    button#submitBtn:disabled { background-color: #a0a0a0; cursor: not-allowed; }
    .image-input .tabs { display: flex; border-bottom: 1px solid var(--medium-gray); margin-bottom: 10px; }
    .image-input .tab { padding: 10px 15px; cursor: pointer; border: 1px solid transparent; border-bottom: none; margin-bottom: -1px; }
    .image-input .tab.active { border-color: var(--medium-gray); border-bottom-color: var(--bg-color); border-radius: 4px 4px 0 0; font-weight: 600; }
    .image-input .tab-content { display: none; }
    .image-input .tab-content.active { display: block; }
    .image-preview {
      width: 100%; min-height: 150px; border: 2px dashed var(--medium-gray); border-radius: 4px;
      margin-top: 10px; display: flex; align-items: center; justify-content: center;
      color: var(--medium-gray); overflow: hidden;
    }
    .image-preview img { width: 100%; height: auto; display: block; }
    #result-wrapper { position: relative; }
    #resultImage { width: 100%; border-radius: 4px; border: 1px solid var(--medium-gray); }
    .loader { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: none; align-items: center; justify-content: center; flex-direction: column; gap: 10px; border-radius: 4px; }
    .spinner { border: 5px solid var(--light-gray); border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto; padding-top: 5px; }
    #gallery img { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s; }
    #gallery img:hover, #gallery img.selected { border-color: var(--primary-color); }
  </style>
</head>
<body>

  <div class="main-container">
    <div class="panel controls-panel">
      <h1>AI Virtual Try-On</h1>
      <div class="input-group image-input" data-input-id="person"> <label>1. Person Image</label> <div class="tabs"> <div class="tab active" data-tab="file">Upload</div> <div class="tab" data-tab="url">URL</div> </div> <div class="tab-content active" data-tab-content="file"> <input type="file" class="file-input" accept="image/*"> </div> <div class="tab-content" data-tab-content="url"> <input type="text" class="url-input" placeholder="Paste DIRECT image URL (ends in .jpg, .png)"> </div> <div class="image-preview"><span>Preview</span></div> </div>
      <div class="input-group image-input" data-input-id="product"> <label>2. Product Image</label> <div class="tabs"> <div class="tab active" data-tab="file">Upload</div> <div class="tab" data-tab="url">URL</div> </div> <div class="tab-content active" data-tab-content="file"> <input type="file" class="file-input" accept="image/*"> </div> <div class="tab-content" data-tab-content="url"> <input type="text" class="url-input" placeholder="Paste DIRECT image URL (ends in .jpg, .png)"> </div> <div class="image-preview"><span>Preview</span></div> </div>
      <div class="input-group"> <label>3. Product Details</label> <input type="text" id="productName" placeholder="e.g., Men's Graphic T-Shirt"> <input type="text" id="productSize" placeholder="e.g., Medium"> <textarea id="productDesc" placeholder="e.g., 100% cotton, black with a white logo on the front."></textarea> </div>
      <div class="input-group"> <label>4. Style Options (Optional)</label> <select id="tone"><option value="">-- Select Tone --</option><option value="casual">Casual</option><option value="sporty">Sporty</option><option value="elegant">Elegant</option></select> <select id="style" style="margin-top: 8px;"><option value="">-- Select Style --</option><option value="photorealistic">Photorealistic</option><option value="fashion catalog">Fashion Catalog</option><option value="cinematic">Cinematic</option></select> </div>
      <button id="submitBtn" onclick="submitTryOn()"><span id="btn-text">Generate Try-On</span><div id="btn-spinner" class="spinner" style="display: none; width: 20px; height: 20px;"></div></button>
    </div>
    <div class="panel results-panel">
      <h2>Result</h2>
      <div id="result-wrapper">
        <img id="resultImage" src="https://via.placeholder.com/512x512.png?text=Your+Result+Will+Appear+Here" alt="Result will appear here">
        <div class="loader" id="resultLoader"><div class="spinner"></div><p>Generating your image...</p></div>
      </div>
      <h2>Gallery</h2>
      <p style="font-size: 14px; color: #777;">Generated images are saved on the server. Click one to use it as the "Person Image".</p>
      <div id="gallery"></div>
    </div>
  </div>

<script>
  const imageData = { person: null, product: null };
  const API_BASE_URL = "http://127.0.0.1:8000";

  async function submitTryOn() {
    if (!imageData.person || !imageData.product) {
      alert("Please provide both a person and a product image!");
      return;
    }
    const payload = {
      personImage: imageData.person, productImage: imageData.product,
      productName: document.getElementById("productName").value, productSize: document.getElementById("productSize").value,
      productDesc: document.getElementById("productDesc").value, tone: document.getElementById("tone").value,
      style: document.getElementById("style").value
    };
    toggleLoading(true);
    try {
      const res = await fetch(`${API_BASE_URL}/generate`, {
        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
      });
      const data = await res.json(); // Try to get JSON regardless of res.ok
      if (!res.ok) {
          throw new Error(data.detail || `Server error: ${res.status}`);
      }
      if (data.imageUrl) {
        document.getElementById("resultImage").src = data.imageUrl;
        await loadGallery();
      } else {
        throw new Error("API did not return an image URL.");
      }
    } catch (error) {
      console.error("Error during generation:", error);
      // alert(`Error: ${error.message}`);
    } finally {
      toggleLoading(false);
    }
  }

  async function loadGallery() {
    try {
      const res = await fetch(`${API_BASE_URL}/gallery`);
      if (!res.ok) throw new Error("Failed to fetch gallery from server.");
      const imageUrls = await res.json();
      const galleryDiv = document.getElementById('gallery');
      galleryDiv.innerHTML = '';
      imageUrls.forEach(url => {
        const img = document.createElement('img');
        img.src = url;
        img.alt = 'Generated image from gallery';
        img.onclick = () => handleGalleryImageClick(img, url);
        galleryDiv.appendChild(img);
      });
    } catch (error) {
      console.error("Could not load gallery:", error);
      document.getElementById('gallery').innerHTML = '<p>Error loading gallery.</p>';
    }
  }

  async function handleGalleryImageClick(imgElement, imageUrl) {
    document.querySelectorAll('#gallery img.selected').forEach(el => el.classList.remove('selected'));
    imgElement.classList.add('selected');
    const personPreview = document.querySelector('.image-input[data-input-id="person"] .image-preview');
    personPreview.innerHTML = `<span>Loading from gallery...</span>`;
    const base64Data = await urlToBase64(imageUrl);
    if (base64Data) {
      imageData.person = base64Data;
      personPreview.innerHTML = `<img src="${imageUrl}" alt="Selected from gallery">`;
      // alert('Image loaded and is now set as the Person Image.');
    } else {
      personPreview.innerHTML = `<span>Failed to load image</span>`;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    setupImageInputs();
    loadGallery();
  });

  // --- Helper Functions ---
  async function urlToBase64(url) {
    try {
      // This correctly calls your robust backend proxy
      const proxyUrl = `${API_BASE_URL}/proxy-image?url=${encodeURIComponent(url)}`;
      const response = await fetch(proxyUrl);
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || `Failed via proxy: ${response.statusText}`);
      }
      const blob = await response.blob();
      return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
      });
    } catch (error) {
        console.error("URL to Base64 conversion failed:", error);
        alert(`Failed to load image from URL. Reason: ${error.message}`);
        return null;
    }
  }

  function fileToBase64(file) {
      return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(",")[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
      });
  }

  function setupImageInputs() {
    document.querySelectorAll('.image-input').forEach(container => {
      const inputId = container.dataset.inputId;
      const fileInput = container.querySelector('.file-input');
      const urlInput = container.querySelector('.url-input');
      const preview = container.querySelector('.image-preview');
      fileInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (file) {
          imageData[inputId] = await fileToBase64(file);
          preview.innerHTML = `<img src="${URL.createObjectURL(file)}" alt="Preview">`;
        }
      });
      urlInput.addEventListener('blur', async () => {
        const url = urlInput.value.trim();
        if (url) {
          preview.innerHTML = `<span>Loading from URL...</span>`;
          const base64 = await urlToBase64(url);
          if (base64) {
            imageData[inputId] = base64;
            // We use the original URL for the preview to avoid a long data URI
            preview.innerHTML = `<img src="${url}" alt="Preview">`;
          } else {
            preview.innerHTML = `<span>Failed to load. Is it a direct link to a JPG/PNG?</span>`;
            imageData[inputId] = null;
          }
        }
      });
      container.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          container.querySelector('.tab.active').classList.remove('active');
          tab.classList.add('active');
          const tabName = tab.dataset.tab;
          container.querySelector('.tab-content.active').classList.remove('active');
          container.querySelector(`.tab-content[data-tab-content="${tabName}"]`).classList.add('active');
        });
      });
    });
  }

  function toggleLoading(isLoading) {
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btn-text');
    const btnSpinner = document.getElementById('btn-spinner');
    const resultLoader = document.getElementById('resultLoader');
    if (isLoading) {
      submitBtn.disabled = true; btnText.textContent = 'Generating...';
      btnSpinner.style.display = 'block'; resultLoader.style.display = 'flex';
    } else {
      submitBtn.disabled = false; btnText.textContent = 'Generate Try-On';
      btnSpinner.style.display = 'none'; resultLoader.style.display = 'none';
    }
  }
</script>

</body>
</html>